<!DOCTYPE html>
<html>

<head>
    <title>line test</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/vue_2.6.0.js"></script>
    <script type="text/javascript" src="js/geoutil.js"></script>
    <script type="text/javascript" src="GPXParser.js"></script>
    <script type="text/javascript" src="helpers.js"></script>
    <style>
        html,
        body {
            margin: 0px;
            height: 100%;
            width: 100%;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: -4 !important;
        }

        .on-top {
            z-index: 2 !important;
        }

        #holder {
            font-family: sans-serif;
            color: #8a8f96;
            width: 100%;
            height: 100px;
            margin: 0 auto;
            position: absolute;
            z-index: 1;

        }

        #holder.hover {
            border: 1px dashed #333;
        }

        #holder .success {
            display: none;
        }

        #app {
            top: 50%;
            left: 50%;
            margin-top: -100px;
            margin-left: -100px;
            width: 200px;
            height: 200px;
            position: absolute;
            display: block;
            border: 1px solid;
        }

        #app .display {
            width: 100%;
            background-color: white;
            position: absolute;
            bottom: 0px;
        }

        #app .display span {
            text-align: right;
        }

    </style>
    <title>Garmin gpx 3d visualizer</title>
</head>
<body>
<div id="holder">
    <input type="file" id="fileElem" accept="*.gpx" onchange="onSelectFile(this.files)">
    <div id="status">File API &amp; FileReader API not supported</div>
</div>

<div id="map"></div>
<div id="app">
    <div class="display">
        <div class="c" style="float:left;">{{state.speed}}km/h</div>
        <div class="c" style="float:right;">alt {{state.alt}}m</div>
        <div style="clear:both;"></div>
        <div>{{state.lat}} {{state.lng}}</div>
    </div>
</div>
<script src="js/time-seeker.js"></script>

<script type="text/javascript" src="js/map.js"></script>
<script>

    let vueApp = new Vue({
        el: "#app",
        data: {
            state: {
                speed: 0,
                alt: 0,
                lat: 0,
                lng: 0,
            },
            ts: null,
            ui: {
                follow: false
            },
            timeFilter: {
                start: 0,
                stop: 0,
            },
            mapPoints: {},
        },
        mounted() {
            setTimeout(MAP.init, 100);
        },
        beforeMount() {
        },
        methods: {
            selectDataFile(data, duration) {
                console.log(data);
                this.clear();
                MAP.methods.clear();
                let start = data[0];
                MAP.methods.setStart(start.lat, start.lng);

                let offset = 0;
                let step = 1 / 4;
                let index = 0;
                setInterval(() => {
                    if (data[index].offset < offset) {
                        index++;
                        let item = data[index];
                        MAP.methods.addPoint(item.lat, item.lng, 0);
                        this.state.speed = item.speed;
                        this.state.alt = item.alt;
                        this.state.lat = item.lat;
                        this.state.lng = item.lng;

                    }
                    offset += step
                }, step * 10);
            },
            clear() {
                MAP.methods.clear();
            },
        },
        computed: {},
    });


    function onSelectFile(files) {
        // tracksLayer.clear();
        // vectorsLayer.clear();
        var lines = [];
        var lineTrails = [];
        Array.prototype.forEach.call(files, function (file) {
            let tcx = file.name.indexOf('.tcx') !== -1;
            var reader = new FileReader();
            reader.onload = function (e) {
                var contents = e.target.result;
                if (tcx) {

                    const parser = new DOMParser();
                    const doc = parser.parseFromString(contents, "text/xml");

                    let trackpoints = Array.from(doc.getElementsByTagName("Trackpoint"));
                    let lnglats = [];
                    let startTime = new Date(trackpoints[0].getElementsByTagName("Time")[0].textContent);

                    trackpoints.map((el) => {
                        let speed = 0;
                        let time = new Date(el.getElementsByTagName("Time")[0].textContent);
                        let alt = parseInt(el.getElementsByTagName("AltitudeMeters")[0].textContent);
                        let dist = parseInt(el.getElementsByTagName("DistanceMeters")[0].textContent);
                        let position = el.getElementsByTagName("Position");
                        if (position.length === 0) {
                            return;
                        }
                        let extensions = el.getElementsByTagName("Extensions");
                        let lat = parseFloat(el.getElementsByTagName("LatitudeDegrees")[0].textContent).toFixed(5);
                        let lng = parseFloat(el.getElementsByTagName("LongitudeDegrees")[0].textContent).toFixed(5);
                        let hr = parseFloat(el.getElementsByTagName("HeartRateBpm")[0].textContent);
                        let speedEl = extensions[0].getElementsByTagName("ns3:Speed");
                        if (speedEl.length === 1) {
                            speed = parseInt(speedEl[0].textContent);
                        }
                        let p = {
                            time,
                            alt,
                            dist,
                            lat,
                            lng,
                            hr,
                            speed,
                            offset: (time - startTime) / 1000
                        }
                        lnglats.push(p);
                    })

                    vueApp.selectDataFile(lnglats, arrayDateDiff(lnglats, 'time'));
                    return
                }
                var gpx = new gpxParser();
                gpx.parse(contents);
                var guiObj = {};
                gpx.tracks.forEach(function (track) {
                    var baseAltitude = track.points[track.points.length - 1].ele;
                    baseAltitude = 0;
                    var date = gpx.metadata.time;

                    const month = String(date.getMonth()).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const year = date.getFullYear();
                    let dist = 0;
                    const lnglats = track.points.map((l, index) => {
                        dist: dist += track.distance.cumul[index];
                        return {
                            lng: l.lon,
                            lat: l.lat,
                            alt: parseFloat((l.ele - baseAltitude).toFixed(1)),
                            dist: dist,
                            time: l.time,
                            offset: (l.time - track.points[0].time) / 1000
                        };
                    });
                    vueApp.selectDataFile(lnglats, arrayDateDiff(track.points, 'time'));

                })


            };
            reader.readAsText(file);
            // map.fitExtent(tracksLayer.getExtent(), 0);
        });
    }

    var holder = document.getElementById('holder'),
        state = document.getElementById('status');

    if (typeof window.FileReader === 'undefined') {
        state.className = 'fail';
    } else {
        state.className = 'success';
        // state.innerHTML = 'Garmin gpx 3d visualizer';
    }

    holder.ondragover = function () {
        this.className = 'hover';
        return false;
    };
    holder.ondragend = function () {
        this.className = '';
        return false;
    };
    holder.ondrop = function (e) {
        this.className = '';
        e.preventDefault();
        onSelectFile(e.dataTransfer.files);
        return false;
    };


</script>
</body>
</html>